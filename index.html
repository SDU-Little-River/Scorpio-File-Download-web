<script>
    // --- Configuration ---
    const REPO_OWNER = 'DuskScorpio';
    const REPO_NAME = 'Scorpio-File-Downloads';
    const BRANCH = 'main';
    const BASE_DIR = 'Files';

    // --- State Management ---
    let allFiles = [];
    let currentPath = '';
    let currentSource = localStorage.getItem('dataSource') || 'vercel';

    // --- Icons (SVG) ---
    const ICONS = {
        folder: `<svg class="item-icon" viewBox="0 0 24 24" fill="#F7D774"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>`,
        file: `<svg class="item-icon" viewBox="0 0 24 24" fill="#a0a0a0"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>`,
        link: `<svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="currentColor"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>`
    };

    // --- Theme Logic ---
    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const isDark = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
        applyTheme(isDark);
    }
    function applyTheme(isDark) {
        const html = document.documentElement;
        if(isDark) { html.setAttribute('data-theme', 'dark'); id('sunIcon').style.display='none'; id('moonIcon').style.display='block'; }
        else { html.removeAttribute('data-theme'); id('sunIcon').style.display='block'; id('moonIcon').style.display='none'; }
    }
    window.toggleTheme = function() {
        const current = document.documentElement.getAttribute('data-theme') === 'dark';
        localStorage.setItem('theme', !current ? 'dark' : 'light');
        applyTheme(!current);
    }

    // --- Core Logic ---

    async function loadFiles() {
        const container = id('fileListContainer');
        container.innerHTML = `<div class="loading">Loading files via <b>${currentSource === 'vercel' ? 'Proxy API' : 'GitHub'}</b>...</div>`;

        try {
            let data = [];
            if (currentSource === 'vercel') {
                const res = await fetch('/api/files');
                if (!res.ok) throw new Error(res.status === 404 ? "API file not found." : `API Error: ${res.status}`);
                const json = await res.json();
                data = json.tree;
            } else {
                const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/trees/${BRANCH}?recursive=1`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`GitHub API Error: ${res.status}`);
                const json = await res.json();
                data = json.tree;
            }

            if (!data) throw new Error("No data received");
            allFiles = data.filter(item => item.path.startsWith(BASE_DIR));

            if (allFiles.length === 0) {
                container.innerHTML = `<div class="error">No files found in '${BASE_DIR}'</div>`;
            } else {
                // --- 修复重点：智能处理 URL 路径 ---
                handleInitialPath();
            }
        } catch (e) {
            console.error(e);
            container.innerHTML = `<div class="error">Failed: ${e.message}</div>`;
        }
    }

    // 处理初始 URL 逻辑 (区分文件和文件夹)
    function handleInitialPath() {
        const urlParams = new URLSearchParams(window.location.search);
        const pathParam = urlParams.get('path');

        if (pathParam && pathParam.startsWith(BASE_DIR)) {
            // 1. 在文件树中找到这个路径对应的 Item
            const targetItem = allFiles.find(i => i.path === pathParam);

            if (targetItem) {
                if (targetItem.type === 'blob') {
                    // === 情况 A：链接指向一个文件 ===
                    // 行为：进入父文件夹 + 自动弹出下载框

                    // 获取父文件夹路径 (移除文件名)
                    const parentPath = pathParam.substring(0, pathParam.lastIndexOf('/'));

                    // 转换为相对路径
                    const relPath = parentPath.replace(BASE_DIR + '/', '').replace(BASE_DIR, '');

                    currentPath = relPath;
                    renderBreadcrumbs();
                    renderList();

                    // 自动打开模态框
                    showDownloadModal(targetItem.path);

                } else {
                    // === 情况 B：链接指向一个文件夹 ===
                    // 行为：直接进入文件夹
                    const relPath = pathParam.replace(BASE_DIR + '/', '').replace(BASE_DIR, '');
                    currentPath = relPath;
                    renderBreadcrumbs();
                    renderList();
                }
            } else {
                // 路径不存在，回首页
                renderBreadcrumbs();
                renderList();
            }
        } else {
            // 没有参数，回首页
            renderBreadcrumbs();
            renderList();
        }
    }

    function renderBreadcrumbs() {
        const breadContainer = id('breadcrumbs');
        let html = `<span class="crumb" onclick="navigateTo('')">Home</span>`;
        if (currentPath) {
            const parts = currentPath.split('/').filter(Boolean);
            let cumulativePath = '';
            parts.forEach((part, index) => {
                cumulativePath += part + '/';
                html += `<span class="crumb-separator">/</span>`;
                const cleanPath = cumulativePath.slice(0, -1);
                html += (index === parts.length - 1)
                    ? `<span class="crumb-current">${part}</span>`
                    : `<span class="crumb" onclick="navigateTo('${cleanPath}')">${part}</span>`;
            });
        }
        breadContainer.innerHTML = html;

        const folderActions = id('folderActions');
        const btnDownload = id('btnDownloadFolder');

        if (currentPath) {
            folderActions.style.display = 'flex';
            const fullFolderUrl = `https://github.com/${REPO_OWNER}/${REPO_NAME}/tree/${BRANCH}/${BASE_DIR}/${currentPath}`;
            btnDownload.href = `https://download-directory.github.io/?url=${encodeURIComponent(fullFolderUrl)}`;
        } else {
            folderActions.style.display = 'none';
        }
    }

    function renderList(searchQuery = '') {
        const container = id('fileListContainer');
        container.innerHTML = '';
        let itemsToShow = [];

        if (searchQuery) {
            id('folderActions').style.display = 'none';
            itemsToShow = allFiles.filter(item =>
                item.type === 'blob' && item.path.toLowerCase().includes(searchQuery.toLowerCase())
            ).map(item => ({
                name: item.path.split('/').pop(),
                path: item.path,
                type: 'file',
                displayPath: item.path.replace(BASE_DIR + '/', '')
            }));
        } else {
            if (currentPath) id('folderActions').style.display = 'flex';
            const prefix = currentPath ? `${BASE_DIR}/${currentPath}/` : `${BASE_DIR}/`;
            const processedFolders = new Set();
            allFiles.forEach(item => {
                if (!item.path.startsWith(prefix)) return;
                const relativePart = item.path.slice(prefix.length);
                const segments = relativePart.split('/');
                if (segments.length === 1 && item.type === 'blob') {
                    itemsToShow.push({ name: segments[0], path: item.path, type: 'file' });
                } else if (segments.length > 1) {
                    const folderName = segments[0];
                    if (!processedFolders.has(folderName)) {
                        processedFolders.add(folderName);
                        itemsToShow.push({ name: folderName, path: currentPath ? `${currentPath}/${folderName}` : folderName, type: 'folder' });
                    }
                }
            });
            itemsToShow.sort((a, b) => (a.type === b.type) ? a.name.localeCompare(b.name) : (a.type === 'folder' ? -1 : 1));
        }

        if (itemsToShow.length === 0) {
            container.innerHTML = '<div class="loading">No files found.</div>';
            return;
        }

        itemsToShow.forEach(item => {
            const div = document.createElement('div');
            div.className = 'file-item';
            let displayName = searchQuery ? `<div>${item.name}<div style="font-size:12px;color:var(--sub-text-color)">${item.displayPath}</div></div>` : item.name;

            div.innerHTML = `
                ${item.type === 'folder' ? ICONS.folder : ICONS.file}
                <div class="item-name">${displayName}</div>
                <div class="list-copy-btn" title="Copy Link">
                    ${ICONS.link}
                </div>
            `;

            div.onclick = (e) => {
                if(e.target.closest('.list-copy-btn')) return;
                if (item.type === 'folder') navigateTo(item.path);
                else showDownloadModal(item.path);
            };

            const copyBtn = div.querySelector('.list-copy-btn');
            copyBtn.onclick = (e) => {
                e.stopPropagation();
                const link = generateDeepLink(item.path);
                copyToClipboard(link);
            };

            container.appendChild(div);
        });
    }

    function generateDeepLink(itemPath) {
        const baseUrl = window.location.origin + window.location.pathname;
        return `${baseUrl}?path=${encodeURIComponent(itemPath)}`;
    }

    function copyCurrentUrl() {
        copyToClipboard(window.location.href);
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast("Link Copied!");
        }).catch(err => {
            console.error('Failed to copy: ', err);
            showToast("Failed to copy");
        });
    }

    function showToast(msg) {
        const toast = id('toast');
        toast.innerText = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    window.navigateTo = function(path) {
        currentPath = path;
        id('searchInput').value = '';
        let newUrl = window.location.pathname;
        if (path) {
            const fullRelPath = `${BASE_DIR}/${path}`;
            newUrl = `?path=${encodeURIComponent(fullRelPath)}`;
        }
        window.history.pushState({path: path}, '', newUrl);
        renderBreadcrumbs();
        renderList();
    }

    window.onpopstate = function(event) {
        // Handle browser Back/Forward
        const urlParams = new URLSearchParams(window.location.search);
        const pathParam = urlParams.get('path');
        // Re-use the smart handler
        if (pathParam) {
            handleInitialPath();
        } else {
            currentPath = '';
            renderBreadcrumbs();
            renderList();
        }
    };

    id('searchInput').addEventListener('input', (e) => renderList(e.target.value.trim()));

    function showDownloadModal(fullRepoPath) {
        const encodedPath = fullRepoPath.trim().split('/').map(encodeURIComponent).join('/');
        const repoBase = `https://github.com/${REPO_OWNER}/${REPO_NAME}/raw/${BRANCH}/`;
        const mirrors = [
            { name: 'GitHub Raw (Official)', baseUrl: repoBase },
            { name: 'Mirror 1 (github.tbedu.top)', baseUrl: 'https://github.tbedu.top/' + repoBase },
            { name: 'Mirror 2 (gh.llkk.cc)', baseUrl: 'https://gh.llkk.cc/' + repoBase },
            { name: 'Mirror 3 (gh-proxy.com)', baseUrl: 'https://gh-proxy.com/' + repoBase },
            { name: 'Mirror 4 (github.7boe.top)', baseUrl: 'https://github.7boe.top/' + repoBase },
            { name: 'Mirror 5 (fastgit.cc)', baseUrl: 'https://fastgit.cc/' + repoBase }
        ];
        const linksHtml = mirrors.map(mirror => `
            <a href="${mirror.baseUrl + encodedPath}" class="download-button" target="_blank">
                ${mirror.name}
                <svg class="download-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </a>
        `).join('');
        id('downloadFileName').innerText = fullRepoPath.split('/').pop();
        id('downloadLinks').innerHTML = linksHtml;
        id('downloadOverlay').classList.add('active');
        id('downloadModal').classList.add('active');
    }

    window.openSettings = function() {
        updateSettingsUI();
        id('downloadOverlay').classList.add('active');
        id('settingsModal').classList.add('active');
    }
    window.closeAllModals = function() {
        id('downloadOverlay').classList.remove('active');
        id('downloadModal').classList.remove('active');
        id('settingsModal').classList.remove('active');
    }
    window.changeSource = function(source) {
        currentSource = source;
        localStorage.setItem('dataSource', source);
        updateSettingsUI();
        closeAllModals();
        loadFiles();
    }
    function updateSettingsUI() {
        id('btnSourceVercel').classList.remove('active');
        id('btnSourceGithub').classList.remove('active');
        if (currentSource === 'vercel') id('btnSourceVercel').classList.add('active');
        else id('btnSourceGithub').classList.add('active');
    }
    function id(name) { return document.getElementById(name); }

    initTheme();
    loadFiles();
</script>